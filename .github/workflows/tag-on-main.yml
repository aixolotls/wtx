name: Tag Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve bump level from merged PR labels
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;
            let bump = 'patch';

            try {
              const prs = await github.request('GET /repos/{owner}/{repo}/commits/{commit_sha}/pulls', {
                owner,
                repo,
                commit_sha: sha,
                mediaType: { previews: ['groot'] },
              });

              const mergedPR = prs.data.find((pr) => pr.merged_at) || prs.data[0];
              if (mergedPR) {
                const labels = (mergedPR.labels || []).map((l) => String(l.name || '').toLowerCase());
                if (labels.some((l) => l === 'major' || l === 'semver:major' || l === 'release:major')) {
                  bump = 'major';
                } else if (labels.some((l) => l === 'minor' || l === 'semver:minor' || l === 'release:minor')) {
                  bump = 'minor';
                }
              }
            } catch (error) {
              core.warning(`Unable to resolve PR labels for ${sha}: ${error.message}`);
            }

            core.info(`Using bump level: ${bump}`);
            core.setOutput('level', bump);

      - name: Compute next tag
        id: next
        run: |
          set -euo pipefail

          git fetch --tags --force

          latest="$(git tag --list 'v*' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1 || true)"
          if [ -z "$latest" ]; then
            latest="v0.0.0"
          fi

          ver="${latest#v}"
          major="${ver%%.*}"
          rest="${ver#*.}"
          minor="${rest%%.*}"
          patch="${ver##*.}"

          bump="${{ steps.bump.outputs.level }}"
          case "$bump" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            *)
              patch=$((patch + 1))
              ;;
          esac

          next="v${major}.${minor}.${patch}"
          echo "value=$next" >> "$GITHUB_OUTPUT"
          echo "Next tag: $next"

      - name: Create and push tag
        run: |
          set -euo pipefail

          tag="${{ steps.next.outputs.value }}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists; skipping"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "$tag"
          git push origin "$tag"
