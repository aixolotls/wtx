name: Tag Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.push_tag.outputs.tag }}
      created: ${{ steps.push_tag.outputs.created }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve bump level from merged PR labels
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;
            let bump = 'patch';

            try {
              const prs = await github.request('GET /repos/{owner}/{repo}/commits/{commit_sha}/pulls', {
                owner,
                repo,
                commit_sha: sha,
                mediaType: { previews: ['groot'] },
              });

              const mergedPR = prs.data.find((pr) => pr.merged_at) || prs.data[0];
              if (mergedPR) {
                const labels = (mergedPR.labels || []).map((l) => String(l.name || '').toLowerCase());
                if (labels.some((l) => l === 'major' || l === 'semver:major' || l === 'release:major')) {
                  bump = 'major';
                } else if (labels.some((l) => l === 'minor' || l === 'semver:minor' || l === 'release:minor')) {
                  bump = 'minor';
                }
              }
            } catch (error) {
              core.warning(`Unable to resolve PR labels for ${sha}: ${error.message}`);
            }

            core.info(`Using bump level: ${bump}`);
            core.setOutput('level', bump);

      - name: Compute next tag
        id: next
        run: |
          set -euo pipefail

          git fetch --tags --force

          latest="$(git tag --list 'v*' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1 || true)"
          if [ -z "$latest" ]; then
            latest="v0.0.0"
          fi

          ver="${latest#v}"
          major="${ver%%.*}"
          rest="${ver#*.}"
          minor="${rest%%.*}"
          patch="${ver##*.}"

          bump="${{ steps.bump.outputs.level }}"
          case "$bump" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            *)
              patch=$((patch + 1))
              ;;
          esac

          next="v${major}.${minor}.${patch}"
          echo "value=$next" >> "$GITHUB_OUTPUT"
          echo "Next tag: $next"

      - name: Create and push tag
        id: push_tag
        run: |
          set -euo pipefail

          tag="${{ steps.next.outputs.value }}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists; skipping"
            echo "tag=$tag" >> "$GITHUB_OUTPUT"
            echo "created=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "$tag"
          git push origin "$tag"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "created=true" >> "$GITHUB_OUTPUT"

  build_release_assets:
    runs-on: ubuntu-latest
    needs: tag
    if: needs.tag.outputs.created == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build archive
        env:
          CGO_ENABLED: 0
          VERSION: ${{ needs.tag.outputs.tag }}
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          set -euo pipefail
          mkdir -p dist
          go build \
            -trimpath \
            -ldflags="-s -w -X github.com/aixolotls/wtx/cmd.version=${VERSION}" \
            -o "dist/wtx" \
            ./main.go
          tar -czf "dist/wtx_${GOOS}_${GOARCH}.tar.gz" -C dist wtx
          rm -f dist/wtx

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: wtx-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/wtx_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz

  publish_release:
    runs-on: ubuntu-latest
    needs:
      - tag
      - build_release_assets
    if: needs.tag.outputs.created == 'true'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate checksums
        run: |
          set -euo pipefail
          cd dist
          shasum -a 256 wtx_*.tar.gz > checksums.txt

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag.outputs.tag }}
          files: |
            dist/wtx_*.tar.gz
            dist/checksums.txt
          fail_on_unmatched_files: true
